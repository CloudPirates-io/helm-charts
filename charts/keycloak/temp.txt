---
# Source: keycloak/charts/postgres/templates/secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: keycloak-postgres
  namespace: default
  labels:
    helm.sh/chart: postgres-0.9.0
    app.kubernetes.io/name: postgres
    app.kubernetes.io/instance: keycloak
    app.kubernetes.io/version: "18.0"
    app.kubernetes.io/managed-by: Helm
type: Opaque
data:
  postgres-password: "bElLTWVWbnEyekdmOXBzdmZMR2I1STZnbUl5SmV1TEM="
  host: "a2V5Y2xvYWstcG9zdGdyZXMuZGVmYXVsdC5zdmM="
  port: "NTQzMg=="
  username: "cG9zdGdyZXM="
  database: "a2V5Y2xvYWs="
  uri: "cG9zdGdyZXNxbDovL3Bvc3RncmVzOmxJS01lVm5xMnpHZjlwc3ZmTEdiNUk2Z21JeUpldUxDQGtleWNsb2FrLXBvc3RncmVzLmRlZmF1bHQuc3ZjOjU0MzIva2V5Y2xvYWs="
---
# Source: keycloak/templates/secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: keycloak
  namespace: default
  labels:
    helm.sh/chart: keycloak-0.13.2
    app.kubernetes.io/name: keycloak
    app.kubernetes.io/instance: keycloak
    app.kubernetes.io/version: "26.5.2"
    app.kubernetes.io/managed-by: Helm
type: Opaque
data:
  admin-password: "U0lCRVJ6YlcyVWY4SkY2dkE4enFsWjVkOThqUXVoRWw="
---
# Source: keycloak/charts/postgres/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: keycloak-postgres
  namespace: default
  labels:
    helm.sh/chart: postgres-0.9.0
    app.kubernetes.io/name: postgres
    app.kubernetes.io/instance: keycloak
    app.kubernetes.io/version: "18.0"
    app.kubernetes.io/managed-by: Helm
data:
  pg_hba.conf: |
    # Default pg_hba.conf configuration
    # TYPE  DATABASE        USER            ADDRESS                 METHOD

    # "local" is for Unix domain socket connections only
    local   all             all                                     trust
    # IPv4 local connections:
    host    all             all             127.0.0.1/32            trust
    # IPv6 local connections:
    host    all             all             ::1/128                 trust
    # Allow replication connections from localhost, by a user with the
    # replication privilege.
    local   replication     all                                     trust
    host    replication     all             127.0.0.1/32            trust
    host    replication     all             ::1/128                 trust

    # Allow connections from any host with password authentication
    host    all             all             all                     md5
  postgresql.conf: |
    # PostgreSQL configuration file

    # Connection Settings
    listen_addresses = '*'
    max_connections = 100
    
    # Memory Settings
    shared_buffers = 128MB
    effective_cache_size = 4GB
    work_mem = 4MB
    maintenance_work_mem = 64MB
    
    # WAL Settings
    wal_buffers = 16MB
    
    # Checkpoint Settings
    checkpoint_completion_target = 0.7
    
    # Query Planner Settings
    random_page_cost = 1.1
    
    # Logging Settings
    log_destination = 'stderr'
    logging_collector = off
    log_min_messages = warning
    log_min_error_statement = error
    log_statement = 'none'
    log_min_duration_statement = -1
    
    # Shared Libraries
    
    # Locale and Formatting
    datestyle = 'iso, mdy'
    timezone = 'UTC'
    lc_messages = 'en_US.utf8'
    lc_monetary = 'en_US.utf8'
    lc_numeric = 'en_US.utf8'
    lc_time = 'en_US.utf8'
    default_text_search_config = 'pg_catalog.english'
    
    # Set pg_hba.conf file to use
    hba_file = '/etc/postgresql/pg_hba.conf'

    # Additional Configuration
---
# Source: keycloak/charts/postgres/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: keycloak-postgres
  namespace: default
  labels:
    helm.sh/chart: postgres-0.9.0
    app.kubernetes.io/name: postgres
    app.kubernetes.io/instance: keycloak
    app.kubernetes.io/version: "18.0"
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  ports:
    - port: 5432
      targetPort: 5432
      protocol: TCP
      name: postgresql
  selector:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/instance: keycloak
---
# Source: keycloak/charts/postgres/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: keycloak-postgres-headless
  namespace: "default"
  labels:
    helm.sh/chart: postgres-0.9.0
    app.kubernetes.io/name: postgres
    app.kubernetes.io/instance: keycloak
    app.kubernetes.io/version: "18.0"
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  clusterIP: None
  ports:
    - port: 5432
      targetPort: 5432
      protocol: TCP
      name: postgresql
  selector:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/instance: keycloak
---
# Source: keycloak/templates/service-headless.yaml
apiVersion: v1
kind: Service
metadata:
  name: keycloak-headless
  namespace: default
  labels:
    helm.sh/chart: keycloak-0.13.2
    app.kubernetes.io/name: keycloak
    app.kubernetes.io/instance: keycloak
    app.kubernetes.io/version: "26.5.2"
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  clusterIP: None
  publishNotReadyAddresses: true
  ports:
    - port: 8080
      targetPort: 8080
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: keycloak
    app.kubernetes.io/instance: keycloak
---
# Source: keycloak/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: keycloak
  namespace: default
  labels:
    helm.sh/chart: keycloak-0.13.2
    app.kubernetes.io/name: keycloak
    app.kubernetes.io/instance: keycloak
    app.kubernetes.io/version: "26.5.2"
    app.kubernetes.io/managed-by: Helm
spec:
  type: ClusterIP
  ports:
    - port: 8080
      targetPort: 8080
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: keycloak
    app.kubernetes.io/instance: keycloak
---
# Source: keycloak/charts/postgres/templates/statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: keycloak-postgres
  namespace: default
  labels:
    helm.sh/chart: postgres-0.9.0
    app.kubernetes.io/name: postgres
    app.kubernetes.io/instance: keycloak
    app.kubernetes.io/version: "18.0"
    app.kubernetes.io/managed-by: Helm
spec:
  replicas: 1
  serviceName: keycloak-postgres-headless
  updateStrategy:
    type: RollingUpdate
  selector:
    matchLabels:
      app.kubernetes.io/name: postgres
      app.kubernetes.io/instance: keycloak
  template:
    metadata:
      labels:
        helm.sh/chart: postgres-0.9.0
        app.kubernetes.io/name: postgres
        app.kubernetes.io/instance: keycloak
        app.kubernetes.io/version: "18.0"
        app.kubernetes.io/managed-by: Helm
    spec:
      serviceAccountName: default
      automountServiceAccountToken: false
      securityContext: 
        fsGroup: 999
      containers:
        - name: postgres
          securityContext: 
            allowPrivilegeEscalation: false
            capabilities:
              drop:
              - ALL
            readOnlyRootFilesystem: false
            runAsGroup: 999
            runAsNonRoot: true
            runAsUser: 999
          image: docker.io/postgres:18.0@sha256:073e7c8b84e2197f94c8083634640ab37105effe1bc853ca4d5fbece3219b0e8
          imagePullPolicy: Always
          args:
            - -c
            - 'config_file=/etc/postgresql/postgresql.conf'
          env:
            - name: PGDATA
              value: /var/lib/postgresql/18/docker
            - name: POSTGRES_DB
              value: "keycloak"
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: keycloak-postgres
                  key: postgres-password
            - name: POSTGRES_MAX_CONNECTIONS
              value: "100"
          ports:
            - name: postgresql
              containerPort: 5432
              protocol: TCP
          livenessProbe:
            exec:
              command:
                - /bin/bash
                - -c
                - |
                  pg_isready -U postgres -d keycloak -h 127.0.0.1 -p 5432
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 3
          readinessProbe:
            exec:
              command:
                - /bin/bash
                - -c
                - |
                  pg_isready -U postgres -d keycloak -h 127.0.0.1 -p 5432
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 3
          startupProbe:
            exec:
              command:
                - /bin/bash
                - -c
                - |
                  pg_isready -U postgres -d keycloak -h 127.0.0.1 -p 5432
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 30
          resources:
            {}
          volumeMounts:
            - name: data
              mountPath: /var/lib/postgresql
            - name: config
              mountPath: /etc/postgresql
            - name: run
              mountPath: /var/run/postgresql
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: config
          configMap:
            name: keycloak-postgres
            optional: true
        - name: run
          emptyDir: {}
        - name: tmp
          emptyDir: {}
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes:
        - "ReadWriteOnce"
      resources:
        requests:
          storage: "8Gi"
---
# Source: keycloak/templates/statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: keycloak
  namespace: default
  labels:
    helm.sh/chart: keycloak-0.13.2
    app.kubernetes.io/name: keycloak
    app.kubernetes.io/instance: keycloak
    app.kubernetes.io/version: "26.5.2"
    app.kubernetes.io/managed-by: Helm
spec:
  serviceName: keycloak-headless
  podManagementPolicy: OrderedReady
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: keycloak
      app.kubernetes.io/instance: keycloak
  template:
    metadata:
      labels:
        helm.sh/chart: keycloak-0.13.2
        app.kubernetes.io/name: keycloak
        app.kubernetes.io/instance: keycloak
        app.kubernetes.io/version: "26.5.2"
        app.kubernetes.io/managed-by: Helm
    spec:
      serviceAccountName: default
      automountServiceAccountToken: false
      securityContext: 
        fsGroup: 1001
      initContainers:
        - name: copy-quarkus-lib
          securityContext: 
            allowPrivilegeEscalation: false
            capabilities:
              drop:
              - ALL
            readOnlyRootFilesystem: false
            runAsGroup: 1001
            runAsNonRoot: true
            runAsUser: 1001
          image: docker.io/keycloak/keycloak:26.5.2@sha256:fb31a59deb46f746f2aaa25adc5da39ceccac4fd22d36a519562b0bf02e8df20
          imagePullPolicy: Always
          command: ["sh", "-c", "cp -r /opt/keycloak/lib/quarkus/* /shared-quarkus/"]
          volumeMounts:
            - name: keycloak-lib-quarkus
              mountPath: /shared-quarkus
          resources:
            {}
        - name: wait-for-postgres
          securityContext: 
            allowPrivilegeEscalation: false
            capabilities:
              drop:
              - ALL
            readOnlyRootFilesystem: false
            runAsGroup: 1001
            runAsNonRoot: true
            runAsUser: 1001
          image: postgres:17.6@sha256:e6a4209d1a4893f2df3bdcde58f8926c3c929c4d51df90990ed1b36d83c1382a
          command: ["sh", "-c", "until pg_isready -h keycloak-postgres -p 5432 -U postgres; do echo waiting for database; sleep 2; done;"]
          resources:
            {}
      containers:
        - name: keycloak
          securityContext: 
            allowPrivilegeEscalation: false
            capabilities:
              drop:
              - ALL
            readOnlyRootFilesystem: false
            runAsGroup: 1001
            runAsNonRoot: true
            runAsUser: 1001
          image: docker.io/keycloak/keycloak:26.5.2@sha256:fb31a59deb46f746f2aaa25adc5da39ceccac4fd22d36a519562b0bf02e8df20
          imagePullPolicy: Always
          command:
            - /opt/keycloak/bin/kc.sh
          args:
            - start-dev
            - --http-enabled=true
            - --hostname-strict=false
            - --http-port=8080
            - --https-port=8443
            - --db=postgres
            - --db-url=jdbc:postgresql://keycloak-postgres:5432/keycloak
          env:
            - name: KC_HTTP_RELATIVE_PATH
              value: "/"
            - name: KC_BOOTSTRAP_ADMIN_USERNAME
              value: "admin"
            - name: KC_BOOTSTRAP_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: keycloak
                  key: admin-password
            - name: KC_DB
              value: postgres
            - name: KC_DB_USERNAME
              value: "postgres"
            - name: KC_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: keycloak-postgres
                  key: postgres-password
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /realms/master
              port: http
              scheme: HTTP
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /realms/master
              port: http
              scheme: HTTP
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 3
          startupProbe:
            httpGet:
              path: /realms/master
              port: http
              scheme: HTTP
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 60
          resources:
            {}
          volumeMounts:
            - name: data
              mountPath: /opt/keycloak/data
            - name: tmp
              mountPath: /tmp
            - name: keycloak-work
              mountPath: /opt/keycloak/work
            - name: keycloak-lib-quarkus
              mountPath: /opt/keycloak/lib/quarkus
            - name: keycloak-themes
              mountPath: /opt/keycloak/themes
            - name: keycloak-providers
              mountPath: /opt/keycloak/providers
      volumes:
        - name: data
          emptyDir: {}
        - name: tmp
          emptyDir: {}
        - name: keycloak-work
          emptyDir: {}
        - name: keycloak-lib-quarkus
          emptyDir: {}
        - name: keycloak-themes
          emptyDir: {}
        - name: keycloak-providers
          emptyDir: {}
