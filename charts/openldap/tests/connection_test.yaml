suite: Test connection to OpenLDAP
templates:
  - statefulset.yaml
  - service.yaml
  - secret.yaml
tests:
  - it: should create a StatefulSet
    template: statefulset.yaml
    asserts:
      - isKind:
          of: StatefulSet
      - equal:
          path: metadata.name
          value: RELEASE-NAME-openldap

  - it: should create a Service
    template: service.yaml
    documentIndex: 0
    asserts:
      - isKind:
          of: Service
      - equal:
          path: spec.ports[0].port
          value: 389
      - equal:
          path: spec.ports[1].port
          value: 636

  - it: should create a Secret when existingSecret is not set
    template: secret.yaml
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: RELEASE-NAME-openldap

  - it: should not create a Secret when existingSecret is set
    template: secret.yaml
    set:
      auth.existingSecret: "my-secret"
    asserts:
      - hasDocuments:
          count: 0

  - it: should set correct image
    template: statefulset.yaml
    set:
      image.registry: docker.io
      image.repository: cloudpirates/openldap
      image.tag: "2.6.9"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: docker.io/cloudpirates/openldap:2.6.9

  - it: should configure persistence correctly
    template: statefulset.yaml
    set:
      persistence.enabled: true
      persistence.size: 10Gi
    asserts:
      - equal:
          path: spec.volumeClaimTemplates[0].spec.resources.requests.storage
          value: 10Gi
